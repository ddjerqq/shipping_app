@page "/races/{Id}"
@using Application.Services
@using Domain.Common
@using Domain.Entities
@using Domain.ValueObjects
@using Presentation.Components.Pages.Packages
@using Presentation.Services
@layout HomeLayout
@attribute [StreamRendering]
@attribute [Authorize(Roles = "Staff,Admin")]
@inject IAppDbContext DbContext
@inject FileDownloader FileDownloader

<PageTitle>@Locale.race_details</PageTitle>

@if (Race is not null)
{
    <Card>
        <Header>
            <CardTitle>@Locale.race_details @Race.QualifiedName</CardTitle>
            <Description>
                <Button @onclick="@Export">
                    <Blazicon Svg="@Lucide.Download"/>
                    @Locale.export
                </Button>
            </Description>
        </Header>
        <Content>
            <AppForm @bind-Model="Race" OnValidSubmit="Update">
                <FormField>
                    <FormLabel for="name">@Locale.name</FormLabel>
                    <FormInputText id="name"
                                   disabled="@IsLoading"
                                   @bind-Value="@Race.Name"
                                   placeholder="Enter flight code"
                                   required/>
                    <FormDescription>@Locale.flight_code (eg. US1001)</FormDescription>
                    <FormInvalidFeedback For="@(() => Race.Name)"/>
                </FormField>

                <InlineFormFieldContainer>
                    <FormField>
                        <FormLabel for="origin">Origin</FormLabel>
                        <FormInputText id="origin"
                                       disabled="@IsLoading"
                                       @bind-Value="@Race.Origin"
                                       placeholder="Enter origin"
                                       required/>
                        <FormDescription>@Locale.airport_name (eg. New York)</FormDescription>
                        <FormInvalidFeedback For="@(() => Race.Origin)"/>
                    </FormField>

                    <FormField>
                        <FormLabel for="destination">@Locale.destination</FormLabel>
                        <FormInputText id="destination"
                                       disabled="@IsLoading"
                                       @bind-Value="@Race.Destination"
                                       placeholder="Enter destination"
                                       required/>
                        <FormDescription>@Locale.airport_name (eg. Tbilisi)</FormDescription>
                        <FormInvalidFeedback For="@(() => Race.Destination)"/>
                    </FormField>
                </InlineFormFieldContainer>

                <InlineFormFieldContainer>
                    <FormField>
                        <FormLabel for="takeoff">@Locale.takeoff</FormLabel>
                        <InputDate id="takeoff"
                                   class="@FormInputText.BaseClass"
                                   Type="InputDateType.Date"
                                   @bind-Value="@Race.Start"
                                   required/>
                        <FormInvalidFeedback For="@(() => Race.Start)"/>
                    </FormField>

                    <FormField>
                        <FormLabel for="landing">@Locale.landing</FormLabel>
                        <InputDate id="landing"
                                   class="@FormInputText.BaseClass"
                                   Type="InputDateType.Date"
                                   @bind-Value="@Race.Arrival"
                                   required/>
                        <FormInvalidFeedback For="@(() => Race.Arrival)"/>
                    </FormField>
                </InlineFormFieldContainer>

                <Button type="submit">
                    @if (IsLoading)
                    {
                        <Blazicon Svg="Icons.Loader" class="mr-2 size-4 animate-spin"/>
                    }
                    @Locale.save
                </Button>

                <h1>@Locale.packages</h1>
                <PackageList Packages="@Race.Packages"/>
            </AppForm>
        </Content>
        <Footer class="text-sm text-muted-foreground">
            @Locale.race ID: @Id
        </Footer>
    </Card>
}

@code {
    [Parameter]
    public string Id { get; set; } = null!;

    private RaceId? RaceId => Domain.Entities.RaceId.TryParse(Id, null, out var id) ? id : null;
    private Race? Race { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Race = await DbContext.Races.FindAsync([RaceId], CancellationToken);
    }

    private async Task Export()
    {
        if (Race is null)
            throw new InvalidOperationException("Race is null");

        var data = Race.Packages
            .Select(package => new
            {
                tracking_code = package.TrackingCode.Value,
                owner_name = package.Owner.Username.CapitalizeName(),
                owner_id = $"#{package.Owner.PersonalId}",
                owner_phone = package.Owner.PhoneNumber,
                owner_email = package.Owner.Email,
                owner_address = package.Owner.AddressInfo.AddressToString(),
                category = package.Category.GetDisplayName(),
                home_delivery = package.HouseDelivery ? "yes" : "no",
                // Office
                race_name = package.Race?.QualifiedName,
                weight = (float?)package.Weight / 100,
                price = package.Price?.TotalPrice.FormatedValue,
                status = package.CurrentStatus.Status.GetDisplayName(),
            });

        await using var ms = new MemoryStream();
        await ExcelSerializer.WriteToStreamAsync("packages", data, ms, CancellationToken);
        await FileDownloader.DownloadFileAsync($"packages-{Race.QualifiedName}-{DateTime.UtcNow:u}.xlsx", ms, CancellationToken);

        ShowSuccess("data exported successfully");
    }

    private async Task Update()
    {
        await DbContext.SaveChangesAsync(CancellationToken);
        ShowSuccess("Race updated successfully");
    }
}