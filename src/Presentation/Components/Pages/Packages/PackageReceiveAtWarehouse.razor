@page "/packages/receive"
@attribute [Authorize(Roles = "Staff,Admin")]
@using Application.Cqrs.Packages.Commands

<PageTitle>@Locale.receive_package_at_warehouse</PageTitle>

<Card>
    <Header>
        <CardTitle>@Locale.receive_package_at_warehouse</CardTitle>
        <Description>@Locale.when_you_receive_a_package_at_the_warehouse_declare_them_here</Description>
    </Header>
    <Content>
        <AppForm @bind-Model="Command" OnValidSubmit="OnValidSubmit">
            <FormField>
                <FormLabel for="price-per-kg">@Locale.price_per KG</FormLabel>
                <FormInputMoney Id="price-per-kg"
                                disabled="@IsLoading"
                                @bind-Value="@Command.PricePerKg" required/>
                <FormDescription>@Locale.enter_the_price_per_kilogram_here</FormDescription>
                <FormInvalidFeedback For="@(() => Command.PricePerKg)"/>
            </FormField>

            <InlineFormFieldContainer>
                <FormField>
                    <FormLabel for="tracking-code">@Locale.tracking_code</FormLabel>
                    <FormInputText id="tracking-code"
                                   disabled="@(ParametersSuppliedFromQuery || IsLoading)"
                                   @bind-Value="@Command.TrackingCode"
                                   placeholder="Enter tracking code"
                                   required/>
                    <FormInvalidFeedback For="@(() => Command.TrackingCode)"/>
                </FormField>

                <FormField>
                    <FormLabel for="room-code">@Locale.address_2_room_code</FormLabel>
                    <FormInputText id="room-code"
                                   disabled="@(ParametersSuppliedFromQuery || IsLoading)"
                                   @bind-Value="Command.Address2"
                                   placeholder="Enter room code (address 2)"/>
                    <FormInvalidFeedback For="@(() => Command.Address2)"/>
                </FormField>
            </InlineFormFieldContainer>

            <InlineFormFieldContainer class="mt-2 sm:grid-cols-3">
                <FormField>
                    <FormLabel for="y">@Locale.width (cm)</FormLabel>
                    <InputNumber id="y"
                                 class="@FormInputText.BaseClass"
                                 @bind-Value="@Command.Width"
                                 type="number"
                                 step="0.1"
                                 min="0"
                                 max="100"
                                 disabled="@IsLoading"/>
                    <FormInvalidFeedback For="@(() => Command.Width)"/>
                </FormField>

                <FormField>
                    <FormLabel for="z">@Locale.height (cm)</FormLabel>
                    <InputNumber id="z"
                                 class="@FormInputText.BaseClass"
                                 @bind-Value="@Command.Height"
                                 type="number"
                                 step="0.1"
                                 min="0"
                                 max="100"
                                 disabled="@IsLoading"/>
                    <FormInvalidFeedback For="@(() => Command.Height)"/>
                </FormField>

                <FormField>
                    <FormLabel for="x">@Locale.length (cm)</FormLabel>
                    <InputNumber id="x"
                                 class="@FormInputText.BaseClass"
                                 @bind-Value="@Command.Length"
                                 type="number"
                                 step="0.1"
                                 min="0"
                                 max="100"
                                 disabled="@IsLoading"/>
                    <FormInvalidFeedback For="@(() => Command.Length)"/>
                </FormField>
            </InlineFormFieldContainer>

            <FormField>
                <FormLabel for="weight">@Locale.weight (Kg)</FormLabel>
                <InputNumber id="weight"
                             class="@FormInputText.BaseClass"
                             @bind-Value="@Command.WeightKiloGrams"
                             type="number"
                             min="0"
                             step="0.1"
                             max="100"
                             required
                             disabled="@IsLoading"/>
                <FormDescription class="text-xs">
                    @Locale.please_keep_in_mind_the_weight_will_get_rounded_up_to_the_nearest_100_grams
                </FormDescription>
                <FormInvalidFeedback For="@(() => Command.WeightKiloGrams)"/>
            </FormField>

            <FormField class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <Button Variant="destructive" type="button" disabled="@IsLoading" @onclick="ProhibitedItem">
                    <Blazicon Svg="Icons.Trash" class="mr-2 size-4"/>
                    @Locale.package_contains_prohibited_items
                </Button>

                <Button type="submit" disabled="@IsLoading">
                    <Blazicon Svg="Icons.Check" class="mr-2 size-4"/>
                    @Locale.declare
                </Button>
            </FormField>
        </AppForm>
    </Content>
</Card>

@code {
    [SupplyParameterFromQuery(Name = "code")]
    public string? TrackingCode { get; set; }

    [SupplyParameterFromQuery(Name = "room")]
    public string? RoomCode { get; set; }

    private bool ParametersSuppliedFromQuery => !string.IsNullOrWhiteSpace(TrackingCode) && !string.IsNullOrWhiteSpace(RoomCode);

    private ReceivePackageAtWarehouseCommand Command { get; set; } = new();

    protected override void OnParametersSet()
    {
        Command = new ReceivePackageAtWarehouseCommand
        {
            TrackingCode = TrackingCode ?? string.Empty,
            Address2 = RoomCode ?? string.Empty,
        };
    }

    private async Task OnValidSubmit()
    {
        var result = await SendCommandAsync(Command);

        switch (result)
        {
            case ReceivePackageAtWarehouseResult.Success:
                ShowSuccess("The package is saved in the system!");
                // return the user to the all packages page after a delay
                if (ParametersSuppliedFromQuery)
                {
                    await Task.Delay(1000, CancellationToken);
                    NavigationManager.NavigateTo("/packages/all?status=Awaiting");
                }

                break;
            case ReceivePackageAtWarehouseResult.NoOwnerFound:
                ShowWarning("No owner found for this package. The Package has been added to your name. The user will have to ask for the package later.");
                break;
            case ReceivePackageAtWarehouseResult.PackageAlreadyInWarehouse:
                ShowError("The package is already added.");
                break;
            default:
                throw new ArgumentOutOfRangeException();
        }

        Command = new();
    }

    private async Task ProhibitedItem()
    {
        var command = new FlagPackageAsProhibitedCommand(TrackingCode!);
        await SendCommandAsync(command);
        ShowSuccess("Package has been flagged as prohibited, the owner has been informed.");
        NavigationManager.NavigateTo("/packages/all?status=Awaiting");
    }
}
