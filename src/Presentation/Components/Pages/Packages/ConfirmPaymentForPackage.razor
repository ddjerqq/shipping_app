@using Application.Services
@using Blazored.Modal.Services
@using Domain.Aggregates
@inject ICurrentUserAccessor CurrentUserAccessor

<Card class="text-start w-full sm:w-[480px]">
    <Header>
        <CardTitle class="text-2xl">@Locale.pay_for_shipping</CardTitle>
    </Header>

    <Content class="grid gap-6">
        @Locale.would_you_like_to_pay_x_amount @Package.Price?.TotalPrice.FormatedValue? <br/>
        @Locale.your_balance: @CurrentUser.Balance.FormatedValue<br/>
        @Locale.after_this_transaction_you_will_have: @((CurrentUser.Balance - Package.Price?.TotalPrice)?.FormatedValue)
    </Content>

    <Footer class="grid grid-cols-2 gap-4">
        <Button Variant="outline" type="submit" class="w-full" @onclick="@Cancel" disabled="@(!CanPay)">
            <Blazicon Svg="@Lucide.X"/>
            @Locale.cancel
        </Button>

        <Button Variant="default" type="submit" class="w-full" @onclick="@Pay">
            <Blazicon Svg="@Lucide.DollarSign"/>
            @Locale.confirm
        </Button>
    </Footer>
</Card>

@code {
    [CascadingParameter]
    public BlazoredModalInstance BlazoredModal { get; set; } = null!;

    private bool CanPay => CurrentUser?.Balance > Package?.Price?.TotalPrice;
    private async Task Cancel() => await BlazoredModal.CancelAsync();
    private async Task Pay() => await BlazoredModal.CloseAsync(ModalResult.Ok());

    [Parameter, EditorRequired]
    public Package Package { get; set; } = null!;
    private User CurrentUser { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        CurrentUser = await CurrentUserAccessor.GetCurrentUserAsync(CancellationToken);
    }
}