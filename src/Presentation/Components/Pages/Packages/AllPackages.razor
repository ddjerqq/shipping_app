@page "/packages/all"
@layout HomeLayout
@using Application.Services
@using Domain.Aggregates
@using Domain.Common
@using Domain.ValueObjects
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.EntityFrameworkCore
@inject IAppDbContext DbContext
@inject ICurrentUserAccessor CurrentUser
@attribute [StreamRendering]
@attribute [Authorize(Roles = "Staff,Admin")]

<PageTitle>All packages</PageTitle>

@{
    var onSelectedTabChanged = new EventCallbackFactory().Create<object>(this, newStatus =>
    {
        SelectedStatus = (PackageStatus)newStatus;
        BoundStatus = newStatus.ToString();

        var noQueryUrl = NavigationManager.Uri.Split('?')[0];
        var newUrl = QueryHelpers.AddQueryString(noQueryUrl, "status", newStatus.ToString()!);

        NavigationManager.NavigateTo(newUrl);
        InvokeAsync(FetchData);
    });
}

<Tabs Value="SelectedStatus" ValueChanged="@onSelectedTabChanged">
    <Card>
        <Header>
            <CardTitle class="flex flex-col w-full justify-center content-around px-1 gap-2">
                <div class="flex items-center justify-between">
                    <span>All packages</span>

                    <div class="space-x-2">
                        <AuthorizeView Roles="Staff">
                            <Button Href="/packages/receive" class="ms-2">
                                <Blazicon Svg="@Lucide.Inbox"/>
                                Receive
                            </Button>
                        </AuthorizeView>

                        <Button Href="/packages/new" class="ms-2">
                            <Blazicon Svg="@Lucide.PackagePlus"/>
                            Add
                        </Button>
                    </div>
                </div>

                <Description class="flex flex-col items-start gap-2">
                    <List>
                        @foreach (var status in Enum.GetValues<PackageStatus>())
                        {
                            <Trigger Value="@(status)">@status.GetDisplayName()</Trigger>
                        }
                    </List>
                </Description>
            </CardTitle>
        </Header>
        <Content>
            @foreach (var status in Enum.GetValues<PackageStatus>())
            {
                <TabContent Value="@status">
                    <PackageList Packages="@(Packages.Where(x => x.CurrentStatus.Status == status))"/>
                </TabContent>
            }
        </Content>
        <Footer>
            <Paginator State="@PaginatorState" StateChanged="@FetchData"/>
        </Footer>
    </Card>
</Tabs>

@code {
    private IEnumerable<Package> Packages { get; set; } = [];
    private int TotalPackages { get; set; } = 0;

    [SupplyParameterFromQuery(Name = "status")]
    public string? BoundStatus { get; set; }

    private PackageStatus SelectedStatus { get; set; }

    private Paginator.PaginatorState PaginatorState { get; set; } = new(1, 0);

    protected override async Task OnInitializedAsync()
    {
        SelectedStatus = Enum.TryParse<PackageStatus>(BoundStatus, out var selectedStatus) ? selectedStatus : PackageStatus.Awaiting;

        await FetchData();
        StateHasChanged();
    }

    private async Task FetchData()
    {
        TotalPackages = await DbContext.Packages
            .WhereIf(CurrentUser.Role is Role.User, package => package.OwnerId == CurrentUser.Id)
            .Where(package => package.Statuses.OrderByDescending(status => status.Status).First().Status == SelectedStatus)
            .CountAsync();

        PaginatorState = new Paginator.PaginatorState(0, TotalPackages);

        Packages = await DbContext.Packages
            .Include(package => package.Statuses)
            .ThenInclude(status => status.Staff)
            .AsSplitQuery()
            .WhereIf(CurrentUser.Role is Role.User, package => package.OwnerId == CurrentUser.Id)
            .Where(package => package.Statuses.OrderByDescending(status => status.Status).First().Status == SelectedStatus)
            .OrderByDescending(x => x.Id)
            .Skip(PaginatorState.Skip)
            .Take(PaginatorState.PerPage)
            .ToListAsync(CancellationToken);

        StateHasChanged();
    }
}
