@using Application.Common
@using Application.Services
@using Domain.Common
@using Domain.Aggregates
@using Domain.ValueObjects
@using Presentation.Components.Ui.Avatar
@inject IFileStore FileStore

<div class="space-y-2 overflow-y-scroll max-h-[600px]">
    @foreach (var package in Packages)
    {
        <Button @key="package.Id" Href="@($"/packages/{package.Id}")" Variant="outline" Size="lg"
                class="p-4 h-auto justify-center grid grid-cols-2 gap-y-6 md:grid-cols-4">
            <div class="flex gap-4 items-center">
                <Avatar class="hidden md:block size-9">
                    <AvatarImage Src="@(PictureUrls.GetValueOrDefault(package.Id))" Alt="Package image"/>
                    <AvatarFallback>Package image</AvatarFallback>
                </Avatar>

                <div class="flex flex-col gap-1 justify-center">
                    <span class="text-xs text-muted-foreground">@package.Category.GetDisplayName()</span>

                    <span
                        class="w-full truncate font-medium capitalize leading-none flex gap-2 justify-start md:justify-center align-middle">
                        <Blazicon Svg="@Lucide.ClipboardCheck" class="!size-3"/>
                        @package.Description
                    </span>
                </div>
            </div>

            <div class="flex flex-col gap-1 text-start md:text-center justify-center">
                <span class="text-xs text-muted-foreground">@Locale.retail_price</span>
                <span class="font-medium capitalize leading-none">@package.RetailPrice.FormatedValue</span>
            </div>

            @if (package.CurrentStatus.Status == PackageStatus.Awaiting)
            {
                <div class="flex flex-col gap-1 text-start md:text-center justify-center">
                    <span class="text-xs text-muted-foreground">@Locale.website_address</span>
                    <span
                        class="w-full truncate font-medium capitalize leading-none flex gap-2 justify-start md:justify-center align-middle">
                        <Blazicon Svg="@Lucide.Globe" class="!size-3"/>
                        @(package.WebsiteAddress)
                    </span>
                </div>
            }

            @if (package.CurrentStatus.Status == PackageStatus.InWarehouse)
            {
                <div class="flex flex-col gap-1 text-start md:text-center justify-center">
                    <span class="text-xs text-muted-foreground">@Locale.weight (KG)</span>
                    <span
                        class="w-full truncate font-medium capitalize leading-none flex gap-2 justify-start md:justify-center align-middle">
                        <Blazicon Svg="@Lucide.Weight" class="!size-3"/>
                        @($"{package.Weight / 1000:F1}")
                    </span>
                </div>
            }

            @if (package.CurrentStatus.Status == PackageStatus.InTransit)
            {
                <div class="flex flex-col gap-1 text-start md:text-center justify-center">
                    <span class="text-xs text-muted-foreground">@Locale.race</span>
                    <span
                        class="w-full truncate font-medium capitalize leading-none flex gap-2 justify-start md:justify-center align-middle">
                        <Blazicon Svg="@Lucide.Plane" class="!size-3"/>
                        @(package.Race?.QualifiedName)
                    </span>
                </div>
            }

            @if (package.CurrentStatus.Status == PackageStatus.Arrived)
            {
                <div class="flex flex-col gap-1 text-start md:text-center justify-center">
                    <span class="text-xs text-muted-foreground">
                        @Locale.shipping_price
                    </span>
                    <span title="@(package.IsPaid ? "paid" : "not paid")"
                          class="@("w-full truncate font-medium capitalize leading-none flex gap-2 justify-start md:justify-center align-middle " +
                                   (package.IsPaid ? "text-green-700 dark:text-green-400" : "text-red-700 dark:text-red-400"))">
                        <Blazicon Svg="@(package.IsPaid ? Lucide.Check : Lucide.X)" class="!size-4"/>

                        @(package.Price?.TotalPrice.FormatedValue)
                    </span>
                </div>
            }

            <div class="flex flex-col gap-1 text-start md:text-center justify-center">
                <span class="text-xs text-muted-foreground">@Locale.last_update</span>
                <span class="w-full truncate font-medium capitalize leading-none flex gap-2 justify-start md:justify-center align-middle">
                    <Blazicon Svg="@Lucide.Calendar" class="!size-4"/>
                    @package.CurrentStatus.Date.ToString("ddd, MMM dd")
                </span>
            </div>
        </Button>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public IEnumerable<Package> Packages { get; set; } = [];

    private Dictionary<PackageId, string> PictureUrls { get; set; } = [];

    protected override async Task OnInitializedAsync()
    {
        foreach (var package in Packages)
        {
            var url = !string.IsNullOrWhiteSpace(package.PictureFileKey)
                ? await FileStore.GetPresignedFileUrlAsync(package.PictureFileKey)
                : ClaimsPrincipalExt.GetDefaultAvatar();

            PictureUrls.Add(package.Id, url!);
            StateHasChanged();
        }
    }
}