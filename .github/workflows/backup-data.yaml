name: Backup data

on:
  workflow_dispatch:

  workflow_call:

#  schedule:
#    - cron: '0 0 * * 0'

jobs:
  backup-data:
    concurrency: ci-${{ github.ref }}
    runs-on: ubuntu-latest

    steps:
      - name: Get Time âŒš
        id: getdate
        run: echo "date=$(date +'%Y-%m-%dT%H-%M')" >> $GITHUB_OUTPUT

      - name: Set up SSH key ðŸ”‘
        run: |
          mkdir -v -m 700 $HOME/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} > $HOME/.ssh/known_hosts
          echo "${{ secrets.SSH_KEY }}" > $HOME/.ssh/id_rsa
          chmod 400 $HOME/.ssh/id_rsa

      - name: Backup data ðŸ“¦
        env:
          TIMESTAMP: ${{ steps.getdate.outputs.date }}
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "sqlite3 ~/.data/app.db .dump | gzip > ~/.data/backup/$TIMESTAMP.sql.gz"